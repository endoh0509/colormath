$:.unshift(File.dirname(__FILE__) + '/../lib')
require "test/unit"
require "shoulda"
require "colormath"

class ConversionTest < Test::Unit::TestCase
  EPSILON = 1e-2

  EDGE_CASES = [
    [[1,   0,   0], [  0, 1, 0.5 ]],
    [[0.5, 1, 0.5], [120, 1, 0.75]],
    [[0,   0, 0.5], [240, 1, 0.25]],
  ]

  context "with edge cases" do
    EDGE_CASES.each do |(r,g,b), (h,s,l)|
      should "convert RGB(#{r},#{g},#{b}) to HSL(#{h},#{s},#{l})" do
        c = ColorMath::RGB.new(r, g, b)
        assert_in_delta h, c.hue,        EPSILON
        assert_in_delta s, c.saturation, EPSILON
        assert_in_delta l, c.luminance,  EPSILON
      end

      should "convert HSL(#{h},#{s},#{l}) to RGB(#{r},#{g},#{b})" do
        c = ColorMath::HSL.new(h, s, l)
        assert_in_delta r, c.red,   EPSILON
        assert_in_delta g, c.green, EPSILON
        assert_in_delta b, c.blue,  EPSILON
      end
    end
  end

  HSL_SAMPLES = [
    [267.0, 0.14, 0.17],
    [322.0, 0.22, 0.54],
    [211.0, 0.54, 0.19],
    [347.0, 0.90, 0.38],
    [184.0, 0.75, 0.13],
    [177.0, 0.07, 0.14],
    [ 97.0, 0.93, 0.70],
    [139.0, 0.04, 0.37],
    [ 17.0, 0.88, 0.67],
    [162.0, 0.21, 0.61],
    [358.0, 0.78, 0.50],
    [104.0, 0.78, 0.63],
    [280.0, 0.38, 0.66],
    [298.0, 0.06, 0.72],
    [162.0, 0.39, 0.86],
    [305.0, 0.55, 0.16],
    [248.0, 0.80, 0.84],
    [109.0, 0.23, 0.23],
    [328.0, 0.88, 0.88],
    [ 26.0, 0.99, 0.52],
  ]

  context "roundtripping HSL -> RGB -> HSL" do
    HSL_SAMPLES.each do |h,s,l|
      should "roundtrip HSL(#{h},#{s},#{l})" do
        hsl = ColorMath::HSL.new(h, s, l)
        rgb = ColorMath::RGB.new(hsl.red, hsl.green, hsl.blue)

        assert_in_delta h, rgb.hue,        EPSILON
        assert_in_delta s, rgb.saturation, EPSILON
        assert_in_delta l, rgb.luminance,  EPSILON
      end
    end
  end

  RGB_SAMPLES = [
    [0.19, 0.41, 0.70],
    [0.13, 0.22, 0.28],
    [0.45, 0.44, 0.24],
    [0.96, 0.94, 0.24],
    [0.76, 0.01, 0.16],
    [0.55, 0.96, 0.01],
    [0.07, 0.61, 0.73],
    [0.05, 0.58, 0.51],
    [0.43, 0.05, 0.24],
    [0.66, 0.80, 0.80],
    [0.54, 0.35, 0.10],
    [0.12, 0.41, 0.27],
    [0.78, 0.32, 0.93],
    [0.52, 0.15, 0.43],
    [0.17, 0.26, 0.53],
    [0.19, 0.96, 0.66],
    [0.54, 0.36, 0.84],
    [0.12, 0.89, 0.60],
    [0.75, 0.03, 0.83],
    [0.09, 0.35, 0.83],
  ]

  context "roundtripping RGB -> HSL -> RGB" do
    RGB_SAMPLES.each do |r,g,b|
      should "roundtrip RGB(#{r},#{g},#{b})" do
        rgb = ColorMath::RGB.new(r, g, b)
        hsl = ColorMath::HSL.new(rgb.hue, rgb.saturation, rgb.luminance)

        assert_in_delta r, hsl.red,   EPSILON
        assert_in_delta g, hsl.green, EPSILON
        assert_in_delta b, hsl.blue,  EPSILON
      end
    end
  end

  CONVERSION_SAMPLES = {
    [289.029597996389, 0.456343659700626, 0.119189541081876] =>
     [0.153691084826443, 0.0647981497065346, 0.173580932457217],
    [89.0046828486211, 0.842676778621315, 0.163322171848533] =>
     [0.167888282231519, 0.300949973499292, 0.0256943701977745],
    [308.735673030838, 0.0912515362781343, 0.243041302642496] =>
     [0.265219194887663, 0.22086341039733, 0.258761234382098],
    [342.853445792882, 0.96819445664894, 0.607129199882776] =>
     [0.987504530735506, 0.226753869030047, 0.444158076680606],
    [158.261781415309, 0.265578942308169, 0.750474784986043] =>
     [0.684206142303418, 0.816743427668668, 0.768724686337144],
    [169.17085149162, 0.259460374764297, 0.311358567840574] =>
     [0.230573357142584, 0.392143778538564, 0.362982610407586],
    [127.842552586069, 0.616268809460474, 0.995538052500233] =>
     [0.992788293426676, 0.99828781157379, 0.993507131097789],
    [228.730072653318, 0.654582594166846, 0.0227839378241994] =>
     [0.00786996869789883, 0.0134726136480344, 0.0376979069505],
    [212.103482805904, 0.995985530075141, 0.581737157944073] =>
     [0.165153419488266, 0.552527933575366, 0.998320896399881],
    [268.074329446433, 0.315183586658372, 0.886889644886872] =>
     [0.884601272524943, 0.851239117474115, 0.92254017229963],
    [249.227282385166, 0.467274704360493, 0.903188775783907] =>
     [0.871865292874944, 0.857951339609555, 0.948426211958259],
    [67.5597621323338, 0.0849872033903468, 0.553002049027687] =>
     [0.581418201359567, 0.59099115480204, 0.515012943253335],
    [74.4820939877097, 0.104195364554549, 0.985019147429487] =>
     [0.985826562387809, 0.98658008282441, 0.983458212034565],
    [140.401866675662, 0.941033530517777, 0.91401920057779] =>
     [0.833108385340767, 0.994930015814813, 0.888132774176931],
    [292.384623884441, 0.713579826861641, 0.976159161101062] =>
     [0.988852990107995, 0.959146819407321, 0.993171502794802],
    [193.486608812273, 0.213845449835213, 0.655436111221991] =>
     [0.581752691429287, 0.695994882391539, 0.729119531014695],
    [64.4449892624648, 0.940715663371658, 0.84377990462358] =>
     [0.968964268544827, 0.990738595277593, 0.696821213969568],
    [289.636895654363, 0.316590742479654, 0.171943494790431] =>
     [0.207575112376909, 0.117507776110182, 0.226379213470681],
    [165.703496972944, 0.0720046029751611, 0.555419000400128] =>
     [0.523407122033639, 0.587430878766617, 0.572175614901008],
    [71.3657429598491, 0.643372763684774, 0.462327130774184] =>
     [0.647084971813006, 0.759775814626822, 0.164878446921545],
    [169.69925705539, 0.698680348101944, 0.34578267496692] =>
     [0.104191115253411, 0.587374234680428, 0.504421816207219],
    [275.455748554702, 0.735592569857229, 0.972719787852694] =>
     [0.976369160131199, 0.952652666493006, 0.992786909212381],
    [281.837887846016, 0.981626895041332, 0.00915777094461867] =>
     [0.0127049996637778, 0.000168256686752917, 0.0181472852024844],
    [82.3130599598389, 0.140680543138651, 0.647392896796067] =>
     [0.660103241594019, 0.696997855589343, 0.597787938002791],
    [355.039830609205, 0.762871185523946, 0.661397135221465] =>
     [0.919707504096871, 0.40308676634606, 0.445795539180089],
    [65.7938101194479, 0.705367144383645, 0.639023437628187] =>
     [0.844470252387133, 0.893644444617818, 0.384402430638556],
    [308.980390196066, 0.130242334594041, 0.384181972826451] =>
     [0.434218729876312, 0.33414521577659, 0.419240409794529],
    [245.797748549982, 0.539396346602144, 0.309969341003899] =>
     [0.175085086920302, 0.142773010907722, 0.477165671100077],
    [117.000857684778, 0.0188711284892973, 0.784083143490207] =>
     [0.78041589173163, 0.788157738232409, 0.780008548748006],
    [57.2711939572958, 0.846170437530154, 0.168612102149437] =>
     [0.311286678398105, 0.298308970204518, 0.0259375259007689],
    [332.115178304277, 0.569067714010563, 0.790567341950462] =>
     [0.909748705905869, 0.671385977995056, 0.782164347440041],
    [134.218094124289, 0.195016335648634, 0.693164875184911] =>
     [0.633327013495182, 0.753002736874641, 0.661686358485208],
    [249.371803273263, 0.124831556479971, 0.845735580604455] =>
     [0.832494294655306, 0.82647851302183, 0.86499264818708],
    [348.352173206483, 0.325941510778405, 0.254854961060055] =>
     [0.337922772097341, 0.171787150022769, 0.2040391325254],
    [356.449945540105, 0.464320071314013, 0.558430474962291] =>
     [0.763460068317895, 0.353400881606686, 0.37766308901677],
    [73.0214935858743, 0.977840209396263, 0.742367580357983] =>
     [0.884943648023519, 0.994290919527999, 0.490444241187968],
    [136.039978082626, 0.352773134091705, 0.741629464745275] =>
     [0.650483281266515, 0.832775648224036, 0.699216040776993],
    [159.268128792119, 0.31456073459185, 0.495235696080795] =>
     [0.339453991725514, 0.651017400436076, 0.543362526061482],
    [95.4203856831593, 0.102215849739624, 0.487029506354911] =>
     [0.478034893989389, 0.536811641195248, 0.437247371514574],
    [102.533682400682, 0.199841252216013, 0.386385668002385] =>
     [0.354125726001725, 0.463601463734302, 0.309169872270468],
    [15.2282552465596, 0.434966133261923, 0.687768880970748] =>
     [0.823578843498945, 0.620897210922721, 0.551958918442552],
    [210.8699215344, 0.41940356831878, 0.345508585278077] =>
     [0.200601051727678, 0.341306645813667, 0.490416118828477],
    [345.550005992802, 0.191423457289629, 0.691623937890002] =>
     [0.750654349844459, 0.632593525935544, 0.661026495901689],
    [123.28143515651, 0.480245488311155, 0.703400027375168] =>
     [0.56095922868888, 0.845840826061456, 0.57653957017323],
    [328.002187534504, 0.167522967263279, 0.0829466214284564] =>
     [0.0968420855746153, 0.0690511572822975, 0.0838719724779578],
    [300.481843534255, 0.918022263504913, 0.0138940735232466] =>
     [0.0266491423483611, 0.00113900469813207, 0.0264442774336156],
    [20.2024409654293, 0.268772978172514, 0.727325493954997] =>
     [0.800613033016432, 0.703390860939904, 0.654037954893563],
    [80.7315635089362, 0.262321982467543, 0.321950505989587] =>
     [0.348042605218416, 0.406405200977204, 0.237495811001969],
    [156.130180322237, 0.679793651909169, 0.291372020541273] =>
     [0.0932991706333676, 0.489444870449178, 0.331846096770436],
    [14.2527969174067, 0.46671436717069, 0.490104829501361] =>
     [0.718843794849388, 0.370038198160106, 0.261365864153334],
    [149.872249494411, 0.824018931682532, 0.694700849593399] =>
     [0.443128569831767, 0.946273129355031, 0.693629566729005],
    [206.68549166847, 0.135548051604104, 0.127343924633347] =>
     [0.110082703765677, 0.129251006645956, 0.144605145501017],
    [354.509101150967, 0.879643181853198, 0.925513834214917] =>
     [0.991035082090152, 0.859992586339682, 0.871984937824527],
    [337.651912443508, 0.872506198453188, 0.944720425478741] =>
     [0.992952196896394, 0.896488654061087, 0.932418249082635],
    [144.886124167941, 0.307293844606346, 0.431035521874871] =>
     [0.298580959196039, 0.563490084553703, 0.408456982310565],
    [163.275381039064, 0.732019870321056, 0.551946120511571] =>
     [0.223961777751605, 0.879930463271537, 0.697083358011084],
    [267.485335394036, 0.380467333832221, 0.218258082520698] =>
     [0.211297484961477, 0.135218011776715, 0.30129815326468],
    [101.055387240633, 0.0385058598173651, 0.666390393250863] =>
     [0.661656504164575, 0.679236318002072, 0.653544468499655],
    [4.7932165868809, 0.277399518912026, 0.24581276453886] =>
     [0.314001107164375, 0.188519138410163, 0.177624421913345],
    [173.508639039502, 0.374069006354548, 0.537199981105427] =>
     [0.364080837896668, 0.710319124314186, 0.672859829389511],
    [253.519317159525, 0.647220300085458, 0.456964454943344] =>
     [0.294488724825664, 0.161207783286525, 0.752721126600163],
    [238.57766315025, 0.788906839048121, 0.1979823113904] =>
     [0.0417927119239588, 0.0491978526862506, 0.354171910856842],
    [11.0504999532038, 0.989697691585481, 0.387084768526485] =>
     [0.770181670385048, 0.145101609869941, 0.00398786666792272],
    [22.4846378855106, 0.562260705524816, 0.659221615095307] =>
     [0.850827910219427, 0.61122192538619, 0.467615319971186],
    [68.977484948826, 0.118289131725019, 0.269486689351388] =>
     [0.291824755900687, 0.301364035846214, 0.237609342856562],
    [198.815452861429, 0.473201004520984, 0.995333618924817] =>
     [0.993125482712563, 0.996156852376628, 0.997541755137071],
    [282.38582490369, 0.0889136881505975, 0.581197825280282] =>
     [0.596571625558747, 0.54396057932046, 0.618435071240103],
    [227.506707063166, 0.280289362601397, 0.157011681917656] =>
     [0.113002977671983, 0.131330098802373, 0.201020386163329],
    [231.325181036049, 0.0926161201845422, 0.435174525612766] =>
     [0.394870349447363, 0.406524730504899, 0.47547870177817],
    [319.104187272699, 0.717901366307447, 0.306666386205942] =>
     [0.526822603863755, 0.086510168548129, 0.386625750150954],
    [51.6741381416703, 0.478365772771647, 0.580111789183913] =>
     [0.780971937628655, 0.725227476002171, 0.379251640739171],
    [296.410131489257, 0.746837315745109, 0.0938862608439179] =>
     [0.15561357222595, 0.0237684978099011, 0.164004023877935],
    [301.719250469242, 0.0724705056630526, 0.2805658106089] =>
     [0.300898556775491, 0.260233064442309, 0.299733320662562],
    [341.579901842358, 0.132742680768319, 0.551435424477835] =>
     [0.610979088730351, 0.49189176022532, 0.528451764898553],
    [230.572842608624, 0.593790600608214, 0.858490384398902] =>
     [0.774463304759289, 0.800867854922633, 0.942517464038516],
    [331.661921284619, 0.522846783869652, 0.569138554507942] =>
     [0.794413075576894, 0.343864033438991, 0.556658937126379],
    [101.654047516236, 0.743099510903249, 0.673587796666578] =>
     [0.579362200861583, 0.916144545316496, 0.43103104801666],
    [80.8444556230492, 0.221444992661434, 0.994573424381042] =>
     [0.994940161307509, 0.995775112379159, 0.993371736382925],
    [135.563979103183, 0.919258818444309, 0.834619300585789] =>
     [0.682591634248788, 0.98664696692279, 0.761463481647947],
    [195.295704376599, 0.468249063065899, 0.495282443541253] =>
     [0.263366903400073, 0.608954265604473, 0.727197983682434],
    [325.107320298675, 0.0568807531604699, 0.550717770770096] =>
     [0.576273282350308, 0.525162259189884, 0.554885601862278],
    [184.547754244129, 0.31506741945417, 0.188765974816311] =>
     [0.129291966250185, 0.239224210886703, 0.248239983382436],
    [190.683368321233, 0.293122526418332, 0.119838700661654] =>
     [0.0847112779610198, 0.142456816866071, 0.154966123362288],
    [127.99108646637, 0.322491271041651, 0.701139617132473] =>
     [0.604759752397529, 0.797519481867416, 0.630432413487995],
    [178.009491143309, 0.670990905764575, 0.220152638070279] =>
     [0.0724322200450419, 0.367873056095517, 0.35807176274907],
    [134.654046368333, 0.80279134638071, 0.43836041594171] =>
     [0.0864484674278566, 0.790272364455564, 0.258346267797606],
    [24.5666780961814, 0.991915832348549, 0.890211279953905] =>
     [0.999112449580909, 0.870488109611043, 0.781310110326902],
    [229.647312620914, 0.572084956020869, 0.0273625077317962] =>
     [0.0117088286994309, 0.0171107502112521, 0.0430161867641614],
    [79.3314986783204, 0.688378352499234, 0.917536848417192] =>
     [0.937723732716704, 0.97430269684566, 0.860770999988723],
    [312.168869985261, 0.739499281062287, 0.259209389088121] =>
     [0.45089454596338, 0.0675242322128609, 0.373141487559397],
    [232.069274606495, 0.969182524819973, 0.503062838401366] =>
     [0.0214400254463305, 0.148760634539463, 0.984685651356401],
    [311.792459949901, 0.496735054721697, 0.948699771154103] =>
     [0.974182393137105, 0.923217149171101, 0.964165633165338],
    [8.91798134838945, 0.50269441044285, 0.338260682583673] =>
     [0.508302436991069, 0.218766567984697, 0.168218928176278],
    [195.626771726384, 0.419438600574836, 0.129595416514244] =>
     [0.0752380963705965, 0.155638422206466, 0.183952736657892],
    [17.4776649604364, 0.404941002328463, 0.508615185600857] =>
     [0.707597044872632, 0.425557935314308, 0.309633326329082],
    [218.051348519378, 0.252804345880294, 0.161340020772754] =>
     [0.120552562356985, 0.150393552675255, 0.202127479188523],
    [275.360096779882, 0.343004477063039, 0.122181981963565] =>
     [0.129669852568676, 0.080273015133627, 0.164090948793504],
    [233.149160347531, 0.68306185300779, 0.353226407357989] =>
     [0.111950923016756, 0.167048911526546, 0.594501891699221],
    [335.485494073722, 0.26484636101509, 0.799410902404988] =>
     [0.852536194962328, 0.746285609847648, 0.789696953155386],
    [225.822472787805, 0.411020698571639, 0.444262618574571] =>
     [0.261661486738785, 0.347955903924765, 0.626863750410356]
  }

  context "when exercising the algorithm" do
    CONVERSION_SAMPLES.each do |(h,s,l), (r,g,b)|
      should "convert HSL (#{h},#{s},#{l}) to RGB (#{r},#{g},#{b})" do
        c = ColorMath::HSL.new(h, s, l)
        assert_in_delta r, c.red,   EPSILON
        assert_in_delta g, c.green, EPSILON
        assert_in_delta b, c.blue,  EPSILON
      end
    end

    CONVERSION_SAMPLES.each do |(h,s,l), (r,g,b)|
      should "convert RGB (#{r},#{g},#{b}) to HSL (#{h},#{s},#{l})" do
        c = ColorMath::RGB.new(r, g, b)
        assert_in_delta h, c.hue,        EPSILON
        assert_in_delta s, c.saturation, EPSILON
        assert_in_delta l, c.luminance,  EPSILON
      end
    end
  end
end
